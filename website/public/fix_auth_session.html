<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix Auth Session</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #2563eb;
      margin-top: 0;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
    }
    .success {
      background-color: #d1fae5;
      color: #047857;
    }
    .error {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    .info {
      background-color: #e0f2fe;
      color: #0369a1;
    }
    pre {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .btn-danger {
      background-color: #dc2626;
    }
    .btn-danger:hover {
      background-color: #b91c1c;
    }
    .actions {
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 16px;
      background-color: #e5e7eb;
      border: none;
      color: #374151;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
    }
    .tab.active {
      background-color: #fff;
      font-weight: bold;
    }
    .tab-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 0 4px 4px 4px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Authentication Troubleshooter</h1>
    <p>This tool helps diagnose and fix authentication issues preventing access to admin pages.</p>
    
    <div class="actions">
      <button id="tab1" class="tab active" onclick="showTab(1)">1. Diagnose</button>
      <button id="tab2" class="tab" onclick="showTab(2)">2. Fix</button>
      <button id="tab3" class="tab" onclick="showTab(3)">3. Clear</button>
    </div>
    
    <div id="content1" class="tab-content">
      <h2>Step 1: Diagnose Your Session</h2>
      <p>First, let's check your current authentication status:</p>
      <button id="checkSession">Check Current Session</button>
      
      <div id="diagnosticStatus" class="status info">
        Ready to diagnose. Click the button above to check your session.
      </div>
      
      <div id="diagnosticInfo"></div>
    </div>
    
    <div id="content2" class="tab-content" style="display: none;">
      <h2>Step 2: Fix Authentication Session</h2>
      <p>Try these fixes in order until admin access is restored:</p>
      
      <h3>Fix 1: Refresh Auth Token</h3>
      <button id="refreshToken">Refresh Auth Token</button>
      
      <h3>Fix 2: Update Browser State</h3>
      <button id="fixSession">Fix Browser Auth State</button>
      
      <h3>Fix 3: Force Session Sync</h3>
      <button id="forceSync">Force Session Sync</button>
      
      <div id="fixStatus" class="status info">
        Select a fix to apply.
      </div>
    </div>
    
    <div id="content3" class="tab-content" style="display: none;">
      <h2>Step 3: Clear Authentication Data</h2>
      <p>As a last resort, clear all authentication data and start fresh:</p>
      
      <button id="clearSession" class="btn-danger">Clear All Auth Data</button>
      <button id="goToLogin">Go to Login Page</button>
      
      <div id="clearStatus" class="status info">
        Warning: This will log you out completely.
      </div>
    </div>
    
    <div id="sessionInfo"></div>
  </div>
  
  <script>
    function showTab(tabNumber) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      
      // Show the selected tab
      document.getElementById(`content${tabNumber}`).style.display = 'block';
      
      // Update tab classes
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(`tab${tabNumber}`).classList.add('active');
    }
    
    // Check session function
    document.getElementById('checkSession').addEventListener('click', async () => {
      const statusDiv = document.getElementById('diagnosticStatus');
      const infoDiv = document.getElementById('diagnosticInfo');
      
      try {
        statusDiv.className = 'status info';
        statusDiv.textContent = 'Analyzing your session...';
        
        let info = '<h3>Authentication Diagnostics:</h3>';
        
        // Check localStorage
        info += '<h4>LocalStorage:</h4>';
        const authStorage = localStorage.getItem('auth-storage');
        const sbAuthState = localStorage.getItem('sb-auth-state');
        
        if (authStorage) {
          try {
            const parsed = JSON.parse(authStorage);
            info += `<pre>auth-storage: ${JSON.stringify(parsed, null, 2)}</pre>`;
          } catch (e) {
            info += `<p>auth-storage: Invalid JSON</p>`;
          }
        } else {
          info += '<p>auth-storage: Not found</p>';
        }
        
        if (sbAuthState) {
          try {
            const parsed = JSON.parse(sbAuthState);
            info += `<pre>sb-auth-state: ${JSON.stringify(parsed, null, 2)}</pre>`;
          } catch (e) {
            info += `<p>sb-auth-state: Invalid JSON</p>`;
          }
        } else {
          info += '<p>sb-auth-state: Not found</p>';
        }
        
        // Check cookies
        info += '<h4>Cookies:</h4><ul>';
        const cookies = document.cookie.split(';');
        let hasAuthCookies = false;
        
        cookies.forEach(cookie => {
          const [name, value] = cookie.trim().split('=');
          if (name && (name.startsWith('sb-') || name === 'sb-auth')) {
            hasAuthCookies = true;
            info += `<li>${name}: Present</li>`;
          }
        });
        
        if (!hasAuthCookies) {
          info += '<li>No Supabase auth cookies found</li>';
        }
        info += '</ul>';
        
        // Load Supabase
        info += '<h4>Supabase Session:</h4>';
        infoDiv.innerHTML = info + '<p>Loading Supabase client...</p>';
        
        const getSessionScript = document.createElement('script');
        getSessionScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        getSessionScript.onload = async () => {
          try {
            // Get Supabase URL from current origin or prompt
            const supabaseUrl = window.location.hostname === 'localhost' 
              ? window.prompt('Enter your Supabase URL:', 'https://your-project.supabase.co') 
              : window.origin;
            
            if (!supabaseUrl) {
              throw new Error('No Supabase URL provided');
            }
            
            const supabaseKey = window.prompt('Enter your Supabase anonymous key:');
            if (!supabaseKey) {
              throw new Error('No Supabase key provided');
            }
            
            const { createClient } = supabase;
            const supabaseClient = createClient(supabaseUrl, supabaseKey, {
              auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                cookieOptions: {
                  name: 'sb-auth',
                  lifetime: 60 * 60 * 8,
                  domain: '',
                  path: '/',
                  sameSite: 'lax'
                },
              },
            });
            
            // Check session
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (error) {
              info += `<p>Error getting session: ${error.message}</p>`;
              statusDiv.className = 'status error';
            } else if (session) {
              info += `<p>✅ Active session found for: ${session.user.email}</p>`;
              info += `<p>User ID: ${session.user.id}</p>`;
              info += `<p>Role in app_metadata: ${session.user.app_metadata?.role || 'Not set'}</p>`;
              info += `<p>Session expires at: ${new Date(session.expires_at * 1000).toLocaleString()}</p>`;
              
              statusDiv.className = 'status success';
              statusDiv.textContent = 'Session found! If you still cannot access admin pages, try the fixes in the next tab.';
            } else {
              info += '<p>❌ No active Supabase session found</p>';
              statusDiv.className = 'status error';
              statusDiv.textContent = 'No session found. Please login again.';
            }
            
            // Show diagnostic info
            infoDiv.innerHTML = info;
            
            // If problems were found, highlight the Fix tab
            if (!session || !session.user.app_metadata?.role) {
              document.getElementById('tab2').style.backgroundColor = '#fef3c7';
            }
            
          } catch (error) {
            console.error('Error:', error);
            statusDiv.className = 'status error';
            statusDiv.textContent = `Error: ${error.message}`;
            infoDiv.innerHTML = info + `<p>❌ Error: ${error.message}</p>`;
          }
        };
        
        document.head.appendChild(getSessionScript);
        
      } catch (error) {
        console.error('Error:', error);
        statusDiv.className = 'status error';
        statusDiv.textContent = `Error: ${error.message}`;
      }
    });
    
    // Fix functions
    document.getElementById('refreshToken').addEventListener('click', async () => {
      const statusDiv = document.getElementById('fixStatus');
      const sessionInfoDiv = document.getElementById('sessionInfo');
      
      try {
        statusDiv.className = 'status info';
        statusDiv.textContent = 'Refreshing authentication token...';
        
        // Load Supabase
        const getSessionScript = document.createElement('script');
        getSessionScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        getSessionScript.onload = async () => {
          try {
            const supabaseUrl = window.prompt('Enter your Supabase URL:', window.location.origin.includes('localhost') 
              ? 'https://your-project.supabase.co' 
              : window.location.origin);
            const supabaseKey = window.prompt('Enter your Supabase anonymous key:');
            
            if (!supabaseUrl || !supabaseKey) {
              throw new Error('Supabase credentials required');
            }
            
            const { createClient } = supabase;
            const supabaseClient = createClient(supabaseUrl, supabaseKey, {
              auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                cookieOptions: {
                  name: 'sb-auth',
                  lifetime: 60 * 60 * 8,
                  domain: '',
                  path: '/',
                  sameSite: 'lax'
                },
              },
            });
            
            // Force token refresh
            const { data, error } = await supabaseClient.auth.refreshSession();
            
            if (error) {
              throw error;
            }
            
            if (data.session) {
              statusDiv.className = 'status success';
              statusDiv.textContent = 'Token refreshed successfully! Try accessing your admin dashboard.';
              sessionInfoDiv.innerHTML = `<div class="status success">
                <p>Session refreshed for: ${data.session.user.email}</p>
                <p>New expiry: ${new Date(data.session.expires_at * 1000).toLocaleString()}</p>
              </div>`;
            } else {
              statusDiv.className = 'status error';
              statusDiv.textContent = 'No session found to refresh.';
            }
          } catch (error) {
            console.error('Error:', error);
            statusDiv.className = 'status error';
            statusDiv.textContent = `Error: ${error.message}`;
          }
        };
        
        document.head.appendChild(getSessionScript);
        
      } catch (error) {
        console.error('Error:', error);
        statusDiv.className = 'status error';
        statusDiv.textContent = `Error: ${error.message}`;
      }
    });
    
    document.getElementById('fixSession').addEventListener('click', async () => {
      const statusDiv = document.getElementById('fixStatus');
      
      try {
        statusDiv.className = 'status info';
        statusDiv.textContent = 'Fixing browser authentication state...';
        
        // Clear Zustand store
        localStorage.removeItem('auth-storage');
        localStorage.removeItem('sb-auth-state');
        
        // Load Supabase
        const getSessionScript = document.createElement('script');
        getSessionScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        getSessionScript.onload = async () => {
          try {
            const supabaseUrl = window.prompt('Enter your Supabase URL:', window.location.origin.includes('localhost') 
              ? 'https://your-project.supabase.co' 
              : window.location.origin);
            const supabaseKey = window.prompt('Enter your Supabase anonymous key:');
            
            if (!supabaseUrl || !supabaseKey) {
              throw new Error('Supabase credentials required');
            }
            
            const { createClient } = supabase;
            const supabaseClient = createClient(supabaseUrl, supabaseKey, {
              auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                cookieOptions: {
                  name: 'sb-auth',
                  lifetime: 60 * 60 * 8,
                  domain: '',
                  path: '/',
                  sameSite: 'lax'
                },
              },
            });
            
            // Get current session
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
              // Create a fake auth-storage that matches the expected format
              const authStore = {
                state: {
                  user: {
                    id: session.user.id,
                    email: session.user.email,
                    role: session.user.app_metadata?.role === 'admin' ? 'admin' : 'user',
                    firstName: session.user.user_metadata?.firstName,
                    lastName: session.user.user_metadata?.lastName
                  },
                  isAuthenticated: true,
                  isLoading: false
                },
                version: 0
              };
              
              // Store in localStorage
              localStorage.setItem('auth-storage', JSON.stringify(authStore));
              
              statusDiv.className = 'status success';
              statusDiv.textContent = 'Browser state fixed! Try reloading the admin dashboard.';
              
              // Provide a link to admin
              document.getElementById('sessionInfo').innerHTML = `<div class="status success">
                <p>Browser state synchronized with Supabase session.</p>
                <p><a href="/admin/dashboard">Go to Admin Dashboard</a></p>
              </div>`;
            } else {
              statusDiv.className = 'status error';
              statusDiv.textContent = 'No active session found. Please login again.';
            }
          } catch (error) {
            console.error('Error:', error);
            statusDiv.className = 'status error';
            statusDiv.textContent = `Error: ${error.message}`;
          }
        };
        
        document.head.appendChild(getSessionScript);
        
      } catch (error) {
        console.error('Error:', error);
        statusDiv.className = 'status error';
        statusDiv.textContent = `Error: ${error.message}`;
      }
    });
    
    document.getElementById('forceSync').addEventListener('click', async () => {
      const statusDiv = document.getElementById('fixStatus');
      
      try {
        statusDiv.className = 'status info';
        statusDiv.textContent = 'Forcing session synchronization...';
        
        // Clear all cookies with sb prefix
        document.cookie.split(';').forEach(function(c) {
          const trimmed = c.trim();
          const name = trimmed.split('=')[0];
          if (name.startsWith('sb-')) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
          }
        });
        
        // Load Supabase
        const getSessionScript = document.createElement('script');
        getSessionScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        getSessionScript.onload = async () => {
          try {
            const supabaseUrl = window.prompt('Enter your Supabase URL:', window.location.origin.includes('localhost') 
              ? 'https://your-project.supabase.co' 
              : window.location.origin);
            const supabaseKey = window.prompt('Enter your Supabase anonymous key:');
            
            if (!supabaseUrl || !supabaseKey) {
              throw new Error('Supabase credentials required');
            }
            
            const { createClient } = supabase;
            const supabaseClient = createClient(supabaseUrl, supabaseKey, {
              auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                cookieOptions: {
                  name: 'sb-auth',
                  lifetime: 60 * 60 * 8,
                  domain: '',
                  path: '/',
                  sameSite: 'lax'
                },
              },
            });
            
            // Sign out completely
            await supabaseClient.auth.signOut({ scope: 'local' });
            
            statusDiv.className = 'status success';
            statusDiv.textContent = 'Session cleared. Please login again.';
            
            // Redirect to login after a short delay
            setTimeout(() => {
              window.location.href = '/auth/login';
            }, 2000);
            
          } catch (error) {
            console.error('Error:', error);
            statusDiv.className = 'status error';
            statusDiv.textContent = `Error: ${error.message}`;
          }
        };
        
        document.head.appendChild(getSessionScript);
        
      } catch (error) {
        console.error('Error:', error);
        statusDiv.className = 'status error';
        statusDiv.textContent = `Error: ${error.message}`;
      }
    });
    
    // Clear auth data 
    document.getElementById('clearSession').addEventListener('click', () => {
      const statusDiv = document.getElementById('clearStatus');
      
      try {
        // Clear localStorage
        localStorage.clear();
        
        // Clear all cookies
        document.cookie.split(";").forEach(function(c) {
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
        
        statusDiv.className = 'status success';
        statusDiv.textContent = 'All auth data cleared! You can now login again.';
        
        // Show login button
        document.getElementById('goToLogin').style.display = 'block';
      } catch (error) {
        console.error('Error:', error);
        statusDiv.className = 'status error';
        statusDiv.textContent = `Error clearing session: ${error.message}`;
      }
    });
    
    document.getElementById('goToLogin').addEventListener('click', () => {
      window.location.href = '/auth/login';
    });
  </script>
</body>
</html>
